<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, shrink-to-fit=no" />
    <title>CircularLink</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            position: relative
        }
    </style>
</head>

<body>
    <!-- Cabeçalho -->
    <nav class="navbar navbar-expand navbar-dark" style="background-color:rgb(51, 65, 29);">
        <a class="navbar-brand" href="./Cliente.html">
            <img src="rec/CircularLink_logo.svg" alt="" width="45" height="45" />
        </a>
        <a class="navbar-brand" href="./Cliente.html">CircularLink</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample02"
            aria-controls="navbarsExample02" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarsExample02">
            <ul class="navbar-nav">
                <li class="nav-item" style="padding-right: 10px;">
                    <a class="nav-link active" href="Conta.html">
                        <img src="rec/user.png" alt="Conta" width="45" height="45" />
                    </a>
                </li>
                <li class="nav-item style=" style="padding-left: 10px;">
                    <a class="nav-link active" href="" onclick="return logout()">
                        <img src="rec/sair.png" alt="Sair" width="45" height="45" />
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <!-- Formulário -->
    <div class="container">
        <div id="aviso" class="mt-2 col-md-12" style="display: none;">
            <h1 class="text-danger"><i class="fa fa-warning ">Anúncio não encontrado.</i></h1>
        </div>
        <div id="anuncio" style="display: none;">
            <!-- Estabelecimento -->
            <div class="row">
                <div class="col-lg-7" style="padding: 10;">
                    <h1 style="margin-top:30px;color: forestgreen;"><b id="anuncioEst"></b></h1>
                </div>
            </div>
            <!-- Titulo + Imagem -->
            <div class="row">
                <div class="col-lg-7" style="padding: 10;">
                    <h2 style="margin-top:50px;color: forestgreen;"><b id="anuncioTitle"></b></h2>
                    <h5 id="anuncioDesc" class="p-heading p-large"></h5>
                </div>
                <div class="col-lg-5" style="padding: 0; text-align:center;margin-top:20px">
                    <div class="image-container" style="margin-top:10px">
                        <img id="anuncioImg" src="" class="img-fluid" style="height:240px" />
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- Ingredientes -->
                <div class="col-lg-8" style="padding: 10;">
                    <h3 style="margin-top:50px;color: forestgreen;"><b>Ingredientes</b></h3>
                    <h5 id="anuncioIngr" class="p-heading p-large"></h5>
                </div>
                <!-- Data de Concepçao -->
                <div class="col-lg-4" style="padding: 10;">
                    <h3 style="margin-top:50px;color: forestgreen;"><b>Data de
                            Concepção</b></h3>
                    <h4 id="anuncioDataCon" class="p-heading p-large font-weight-bold"></h4>
                </div>
            </div>

            <div class="row">
                <!-- Razão de Despacho -->
                <div class="col-lg-8" style="padding: 10;">
                    <h3 style="margin-top:10px;color: forestgreen;"><b>Razão de Despacho</b></h3>
                    <h5 id="anuncioRaz" class="p-heading p-large"></h5>
                </div>
                <!-- Data de Despacho -->
                <div class="col-lg-4" style="padding: 10;">
                    <h3 style="margin-top:10px;color: forestgreen;"><b>Data de Despacho</b></h3>
                    <h4 id="anuncioDataDesp" class="p-heading p-large font-weight-bold"></h4>
                </div>
            </div>
            <!-- Morada -->
            <div class="row" style=" margin-top:20px;">
                <div class="col-lg-12" style="padding: 10;">
                    <h3 style="color: forestgreen;"><b>Morada</b></h3>
                    <h4 id="anuncioMor" class="p-heading p-large font-weight-bold"></h4>
                </div>
            </div>
            <div class="row" style=" margin-top:20px;">
                <div class="col-lg-2">
                    <h3 style="color: forestgreen;"><b>Estado</b></h3>
                </div>
                <div class="col-lg-4">
                    <h3 id="anuncioStatus" class="p-heading p-large font-weight-bold"></h3>
                </div>
            </div>
            <!-- Preço e Contacto -->
            <div class="row" style=" margin-top:20px;">
                <div class="col-lg-1" style="padding: 10;">
                    <h3 style="color: forestgreen;"><b>Preço</b></h3>
                </div>
                <div class="col-lg-6">
                    <h3 id="anuncioPreVen" class="p-heading p-large font-weight-bold"></h3>
                </div>
                <div class="col-lg-2" style="padding: 10;">
                    <h3 style="color: forestgreen;"><b>Contacto</b></h3>
                </div>
                <div class="col-lg-2">
                    <h3 id="anuncioCont" class="p-heading p-large font-weight-bold"></h3>
                </div>
            </div>

            <!-- Rating Form-->
            <div id="ratingForm" class="row" style="margin-top:20px; display: none;">
                <div class="col-lg-2" style="padding: 10;">
                    <h3 style="color: forestgreen;"><b>Avaliação</b></h3>
                </div>
                <div class="col-lg-6" style="margin-top:0px;">
                    <a class="fa fa-star" id="s1" onclick="changeRating(1)"
                        style="color:black; font-size: xx-large;"></a>
                    <a class="fa fa-star" id="s2" onclick="changeRating(2)"
                        style="color:black; font-size: xx-large;"></a>
                    <a class="fa fa-star" id="s3" onclick="changeRating(3)"
                        style="color:black; font-size: xx-large;"></a>
                    <a class="fa fa-star" id="s4" onclick="changeRating(4)"
                        style="color:black; font-size: xx-large;"></a>
                    <a class="fa fa-star" id="s5" onclick="changeRating(5)"
                        style="color:black; font-size: xx-large;"></a>
                </div>
                <div class="col-lg-6" style="margin-top:10px;">
                    <textarea name="descricao" id="ratingDescForm" class="form-control"
                        placeholder="Descrição da Avaliação" rows="2"></textarea>
                </div>
                <div class="col-lg-4" id="btnCompra" style="margin-top:24px;">
                    <button class="btn btn-success btn-lg" type="button" onclick="guardarRating()">
                        Guardar Avaliação</button>
                </div>
            </div>
            <!-- Rating -->
            <div id="rating" class="row" style="margin-top:20px; display: none;">
                <div class="col-lg-2" style="padding: 10;">
                    <h3 style="color: forestgreen;"><b>Avaliação</b></h3>
                </div>
                <div class="col-lg-6" style="margin-top:0px;">
                    <span class="fa fa-star" id="sr1" style="color:black; font-size: xx-large;"></span>
                    <span class="fa fa-star" id="sr2" style="color:black; font-size: xx-large;"></span>
                    <span class="fa fa-star" id="sr3" style="color:black; font-size: xx-large;"></span>
                    <span class="fa fa-star" id="sr4" style="color:black; font-size: xx-large;"></span>
                    <span class="fa fa-star" id="sr5" style="color:black; font-size: xx-large;"></span>
                </div>
                <div class="col-lg-6" style="margin-top:10px;">
                    <h5 id="ratingDesc" class="p-heading p-large"></h5>
                </div>
            </div>
            <!-- Botões -->
            <div class="row" style="margin-top:10px;">
                <div class="col-lg-6" style="margin-top:10px;">

                    <button class="btn btn-secondary btn-lg" type="button"
                        onclick="window.history.back()">Voltar</button>

                </div>
                <div class="col-lg-6" style="margin-top:10px;">
                    <button id="btnEnc" class="btn btn-primary btn-lg" type="button" onclick="encomendar()">
                        Encomendar</button>
                    <button id="btnTake" class=" btn btn-success btn-lg" type="button" onclick="takeaway()">
                        Levantar no Restaurante</button>
                </div>
            </div>
            <div class="row" style="margin-top:10px;">
            </div>
        </div>
    </div>
    <script src="./Scripts/jquery-3.5.1.min.js"></script>
    <script src="./Scripts/bootstrap.min.js"></script>
    <script src="./Scripts/knockout-3.5.1.js"></script>
    <script src="./Scripts/amplify.js"></script>
    <script>
        function logout() {
            amplify.store('CurrentUser', null)
            go_to('./index.html')
        }
        function go_to(hr) {
            window.location.href = hr
        }
        function encomendar() {
            pedidos[id].status = "concluido"
            pedidos[id].comprador = currUser.p
            amplify.store('pedidos', pedidos)
            location.reload()
        }
        function takeaway() {
            pedidos[id].status = "reservado"
            pedidos[id].comprador = currUser.p
            amplify.store('pedidos', pedidos)
            location.reload()
        }
        function guardarRating() {
            if (ratingValue == -1)
                return
            pedidos[id].rate = ratingValue
            pedidos[id].rateDesc = $('#ratingDescForm').val()
            console.log(pedidos[id])
            amplify.store('pedidos', pedidos)
            location.reload()
        }
        function changeRating(n) {
            ratingValue = n
            i = 1
            while (i <= n) {
                document.getElementById("s" + i).style = "color: orange; font-size: xx-large;";
                i++;
            }
            while (i < 6) {
                document.getElementById("s" + i).style = "color: black; font-size: xx-large;";
                i++
            }
        }
        function changeStatus(status) {
            pedidos[id].status = status
            amplify.store("pedidos", pedidos)
            go_to("./Pedidos.html")
        }
        $().ready(function () {
            // Verificar se existe login
            currUser = amplify.store('CurrentUser')
            if (currUser == undefined || currUser.status != "Cliente")
                go_to("./index.html")
            users = amplify.store('users')
            // Obter id do anúncio
            id = window.location.href.toString().split("=")[1]
            pedidos = amplify.store("pedidos")
            // Verificar se anúncio existe e pode ser visualizado
            if (id != undefined && pedidos[id] != undefined && pedidos[id].status == "disponivel" || pedidos[id].comprador == currUser.p) {
                document.getElementById("anuncioEst").innerHTML = users[pedidos[id].partnerID].est;
                document.getElementById("anuncioCont").innerHTML = users[pedidos[id].partnerID].contacto;
                document.getElementById("anuncioTitle").innerHTML = pedidos[id].nome_p;
                document.getElementById("anuncioDesc").innerHTML = pedidos[id].descricao;
                document.getElementById("anuncioImg").src = pedidos[id].imgpath;
                document.getElementById("anuncioIngr").innerHTML = pedidos[id].ingredientes;
                document.getElementById("anuncioRaz").innerHTML = pedidos[id].rdespacho;
                document.getElementById("anuncioDataCon").innerHTML = pedidos[id].datas[0] + " " + pedidos[id].horas[0];
                document.getElementById("anuncioDataDesp").innerHTML = pedidos[id].datas[1] + " " + pedidos[id].horas[1];
                //document.getElementById("anuncioPreOri").innerHTML = pedidos[id].precos[0] + "€";
                document.getElementById("anuncioPreVen").innerHTML = pedidos[id].precos[1] + "€";
                document.getElementById("anuncioMor").innerHTML = users[pedidos[id].partnerID].morada;
                status = ""
                switch (pedidos[id].status) {
                    case "disponivel":
                        status = "Disponível"
                        color = "color: rgb(10, 190, 10)"
                        break
                    case "reservado":
                        status = "Reservado"
                        color = "color: rgb(170, 150, 20)"
                        break
                    case "concluido":
                        status = "Concluído"
                        color = "color: rgb(30, 30, 225)"
                        break
                    case "expirado":
                        status = "Expirado"
                        color = "color: rgb(255, 10, 60)"
                        break
                    default:
                        break
                }
                document.getElementById("anuncioStatus").style = color;
                document.getElementById("anuncioStatus").innerHTML = status;
                if (pedidos[id].status != "disponivel") {
                    $('#btnTake').hide()
                    $('#btnEnc').hide()
                }

                // Verificar avaliação
                if (pedidos[id].comprador == currUser.p && pedidos[id].status != "reservado") {
                    $('#ratingForm').show()
                }
                if (pedidos[id].rate != undefined) {
                    $('#rating').show()
                    $('#ratingForm').hide()
                    if (pedidos[id].rateDesc.length > 0)
                        document.getElementById("ratingDesc").innerHTML = pedidos[id].rateDesc;
                    i = 1
                    while (i <= pedidos[id].rate) {
                        document.getElementById("sr" + i).style = "color: orange; font-size: xx-large;";
                        i++;
                    }
                }
                $('#anuncio').show()
            } else
                $('#aviso').show()

            console.log(id)
            ratingValue = -1

            $('#criar_pedido').click(function () {
                console.log($('#ing').val())
                console.log($('#despacho').val())
                if (validate()) {
                    addpedido()
                    alert('Pedido publicado com sucesso')
                    go_to("./Socio.html")
                }
            })

        })

    </script>
</body>

</html>